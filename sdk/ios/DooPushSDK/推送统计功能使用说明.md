# iOS SDK 推送统计功能使用说明

## 概述

DooPush iOS SDK 现已支持推送点击率和打开率统计功能。SDK 会自动追踪以下事件：

- **推送接收**：用户设备收到推送通知
- **推送点击**：用户点击推送通知
- **应用打开**：用户通过推送通知打开应用

## 功能特性

### ✅ 自动数据收集
- 自动记录推送接收、点击和打开事件
- 本地数据缓存，避免数据丢失
- 支持离线缓存，网络恢复后自动上报

### ✅ 智能上报机制
- 定时自动上报（每30秒检查一次）
- 事件阈值触发（达到10个事件立即上报）
- 应用生命周期触发（后台、终止时上报）

### ✅ 数据去重
- 基于去重键避免重复统计
- 防止同一推送的重复事件记录

## 集成步骤

### 1. 基础配置（无需修改）

SDK 的统计功能会在配置时自动启用：

```swift
DooPushManager.shared.configure(
    appId: "your_app_id",
    apiKey: "your_api_key",
    baseURL: "https://your-server.com/api/v1"
)
```

### 2. 通知代理配置（重要）

需要正确配置 `UNUserNotificationCenterDelegate` 来区分不同的用户行为：

```swift
class NotificationDelegate: NSObject, UNUserNotificationCenterDelegate {
    
    // 前台收到推送时调用
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        willPresent notification: UNNotification,
        withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
    ) {
        let userInfo = notification.request.content.userInfo
        
        // 记录推送接收统计
        _ = DooPushManager.shared.handleNotification(userInfo)
        
        completionHandler([.banner, .sound, .badge])
    }
    
    // 用户与推送交互时调用
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        didReceive response: UNNotificationResponse,
        withCompletionHandler completionHandler: @escaping () -> Void
    ) {
        let userInfo = response.notification.request.content.userInfo
        
        // 根据用户操作类型记录不同统计
        switch response.actionIdentifier {
        case UNNotificationDefaultActionIdentifier:
            // 用户点击通知本身
            _ = DooPushManager.shared.handleNotificationClick(userInfo)
            _ = DooPushManager.shared.handleNotificationOpen(userInfo)
            
        case UNNotificationDismissActionIdentifier:
            // 用户划掉了通知
            _ = DooPushManager.shared.handleNotificationClick(userInfo)
            
        default:
            // 其他自定义操作
            _ = DooPushManager.shared.handleNotificationClick(userInfo)
        }
        
        completionHandler()
    }
}
```

### 3. 设置通知代理

在 App 启动时设置代理：

```swift
@main
struct YourApp: App {
    @StateObject private var notificationDelegate = NotificationDelegate()
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .onAppear {
                    UNUserNotificationCenter.current().delegate = notificationDelegate
                }
        }
    }
}
```

## API 参考

### 主要方法

#### 处理推送接收
```swift
DooPushManager.shared.handleNotification(userInfo)
```
用于记录推送到达统计。

#### 处理推送点击
```swift
DooPushManager.shared.handleNotificationClick(userInfo)
```
用于记录用户点击推送的统计。

#### 处理应用打开
```swift
DooPushManager.shared.handleNotificationOpen(userInfo)
```
用于记录用户通过推送打开应用的统计。

#### 手动上报统计
```swift
DooPushManager.shared.reportStatistics()
```
立即上报所有待处理的统计数据。

## 数据流程

### 1. 事件记录
```
推送接收 → handleNotification → 记录接收事件
用户点击 → handleNotificationClick → 记录点击事件  
应用打开 → handleNotificationOpen → 记录打开事件
```

### 2. 本地缓存
```
事件记录 → 本地 UserDefaults 缓存 → 避免数据丢失
```

### 3. 自动上报
```
定时检查(30s) → 批量上报 → 清理已上报数据
事件阈值(10个) → 立即上报 → 避免数据积压
应用后台/终止 → 强制上报 → 确保数据完整性
```

## 最佳实践

### ✅ 推荐做法

1. **正确区分事件类型**
   - 在 `willPresent` 中只调用 `handleNotification`
   - 在 `didReceive` 中根据操作类型调用对应方法

2. **避免重复调用**
   - 不要在同一个通知事件中多次调用统计方法
   - SDK 有去重机制，但正确调用更高效

3. **测试统计功能**
   - 使用示例应用的"上报统计数据"按钮测试
   - 在开发环境验证数据上报是否正常

### ❌ 避免的错误

1. **不要在多个地方重复调用**
   ```swift
   // ❌ 错误：重复调用
   _ = DooPushManager.shared.handleNotification(userInfo)
   _ = DooPushManager.shared.handleNotificationClick(userInfo) // 重复了
   ```

2. **不要忽略操作类型**
   ```swift
   // ❌ 错误：所有情况都当作打开应用
   _ = DooPushManager.shared.handleNotificationOpen(userInfo)
   ```

3. **不要阻塞主线程**
   ```swift
   // ✅ 正确：SDK 已经处理了线程调度
   _ = DooPushManager.shared.handleNotificationClick(userInfo)
   ```

## 调试和验证

### 1. 查看日志
SDK 会输出详细的统计日志：
```
📊 推送点击统计记录: ...
📊 推送打开统计记录: ...
📊 开始上报 X 个统计事件
📊 统计数据上报成功
```

### 2. 使用示例应用
运行示例应用并：
- 发送测试推送
- 点击推送通知
- 在设置页面点击"上报统计数据"
- 查看控制台日志

### 3. 后端验证
检查后端 `push_statistics` 表中的数据：
```sql
SELECT * FROM push_statistics 
WHERE app_id = 'your_app_id' 
ORDER BY date DESC;
```

## 错误处理

SDK 会自动处理以下错误情况：
- 网络连接失败：数据会本地缓存，网络恢复后重试
- 服务器错误：根据错误类型决定是否重试
- 数据格式错误：丢弃错误数据，避免无限重试

## 注意事项

1. **数据隐私**：统计数据仅包含事件类型和时间戳，不包含推送内容
2. **性能影响**：统计功能使用后台队列，不会影响主线程性能
3. **存储占用**：本地缓存会定期清理，占用空间很小
4. **网络消耗**：采用批量上报，最小化网络请求次数

## 版本兼容性

- iOS 12.0+
- Xcode 14.0+
- Swift 5.0+

## 技术支持

如遇到问题，请提供：
1. iOS 系统版本
2. SDK 版本
3. 详细的错误日志
4. 复现步骤

统计功能现已集成到 SDK 中，无需额外配置即可使用。正确集成后，您就可以在推送统计页面看到详细的点击率和打开率数据。
