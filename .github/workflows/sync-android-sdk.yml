name: Sync Android SDK to External Repository

on:
  push:
    branches:
      - main
    paths:
      - 'sdk/android/DooPushSDK/**'
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-android-sdk:
    runs-on: ubuntu-latest
    if: github.repository == 'doopush/doopush'  # 确保只在主仓库运行
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录
          
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ANDROID_SDK_DEPLOY_KEY }}
          
      - name: Configure Git
        run: |
          git config --global user.name "DooPush Bot"
          git config --global user.email "bot@doopush.com"
          
      - name: Clone target repository
        run: |
          git clone git@github.com:doopush/doopush-android-sdk.git target-repo
          
      - name: Sync SDK files
        run: |
          # 清空目标仓库内容（保留 .git 目录）
          cd target-repo
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # 复制 SDK 文件（包含隐藏文件）
          cp -r ../sdk/android/DooPushSDK/. .
          
          # 添加所有变更
          git add .
          
          # 检查是否有变更
          if git diff --staged --quiet; then
            echo "No changes to sync"
            exit 0
          fi
          
          # 提交变更
          git commit -m "Sync from main repository - $(date '+%Y-%m-%d %H:%M:%S')"
          
          # 推送到目标仓库
          git push origin main